---
title: "Overview map"
output: 
  html_document:
    keep_md: true
    toc: true
    toc_depth: 3
    toc_float: true
    code_folding: hide
    df_print: paged   
---

Makes overview map, using the map data in NIVA's "K:/Kart"  
The "second try" map is the one used   
  
This code uses the new _sf_ package (which supersedes _sp_). It works nicely together with ggplot2 (see below), but for the time being (Dec. 2018) you need the _development version_ of ggplot2. See code below for details.      
  
## Packages
```{r}

# Install
# install.packages("sf")

# Also needs the *development version* of ggplot2
# First, remove folders digest and ggplot2 in your Library folder (I needed to do that, at least)
# (Eh, I don't know where I store my packages? Run: .libPaths() )
# Then:
#   install.packages("digest")
#   devtools::install_github("tidyverse/ggplot2")


library(sf)
library(ggplot2)
library(dplyr)
library(ggrepel)

library("rnaturalearth")
library("rnaturalearthdata")
#install.packages("rgeos")
library ("rgeos")
library("ggspatial")

save_plot <- FALSE
```

## Load basemap
```{r}

world <- ne_countries(scale = "medium", returnclass = "sf")
#class(world)

```

### Stations   

```{r}

df_stations <- read.csv(textConnection("Station_type, Name, Lat, Long 
Hard bottom,HR104, 58.2732, 08.5372
Hard bottom,HT113, 58.5132, 08.9445
Soft bottom,BR1, 58.3253, 08.6295
Soft bottom,BT44, 58.4038, 09.0312
Hydrography/plankton, Arendal 2, 58.3870, 8.8330
River,Glomma, 59.278, 11.134
River,Drammenselva, 59.75399, 10.00903
River,Numedalslågen, 59.08627, 10.06962
River,Skienselva, 59.199, 9.611
"), stringsAsFactors = FALSE)

df_stations$Station_type <- factor(
  df_stations$Station_type,
  levels = c("River", "Hydrography/plankton", "Hard bottom", "Soft bottom"))

sf_stations <- st_as_sf(df_stations, coords = c("Long", "Lat"), crs = "+proj=longlat")
sf_stations[1,]

```

### Rivers    

- 
- takes a minute or something to read

```{r}

# Using st_read in package sf
fn <- "C:/Data/Mapdata/NVE_ELVIS_elvenett/NVEData/Elv_Hovedelv.geojson"
sf_rivers_all <- sf::st_read(fn)

# str(sf_rivers_all, 1)  

```


#### Select rivers  
```{r}

sel <- grepl("Glomma", sf_rivers$elvenavn); sum(sel)

rivernames <- c("Glommavassdraget", "Drammensvassdraget", "Skiensvassdraget", "Numedalslågen")

sf_rivers <- sf_rivers_all %>%
  filter(elvenavn %in% rivernames)

nrow(sf_rivers)

```

#### Test plot  
```{r}

ggplot(data = world) +
  geom_sf() +
  geom_sf(data = sf_rivers, color = "blue", show.legend = "point") + 
    coord_sf(xlim = c(5, 13), ylim = c(57, 60))

```

```{r}

leftside <- sf_stations$Name %in% c("HR104", "Arendal 2")
table(sf_stations$Name)
sum(leftside)

p <- ggplot(data = world) +
  geom_sf() +
  geom_sf(data = sf_rivers, color = "blue", show.legend = "point") + 
  geom_sf(data = sf_stations, aes(color = Station_type, pch = Station_type), show.legend = "point") + 
  geom_sf_text(data = sf_stations[!leftside,], aes(label = Name), hjust = -0.1) +
  geom_sf_text(data = sf_stations[leftside,], aes(label = Name), hjust = 1.1) +
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(5, 13), ylim = c(57, 60))+
     guides(color = guide_legend(override.aes = list(size = 3) ) )

p + 
  scale_shape_discrete("Station Type") +
  scale_color_discrete("Station Type")

# Hard bottom,HR104, 58.2732, 08.5372
# Hard bottom,HT113, 58.5132, 08.9445
# Soft bottom,BR1, 58.3253, 08.6295
# Soft bottom,BT44, 58.4038, 09.0312
# Hydrography/plankton, Arendal 2, 58.3870, 8.8330

```

```{r}

p <- ggplot(data = world) +
  geom_sf() +
  geom_sf(data = sf_rivers, color = "blue", show.legend = "point") + 
  geom_sf(data = sf_stations, aes(color = Station_type, pch = Station_type), show.legend = "point") + 
  geom_sf_text(data = sf_stations, aes(label = Name), adj = -0.1) +
    annotation_scale(location = "bl", width_hint = 0.5) +
    annotation_north_arrow(location = "bl", which_north = "true", 
        pad_x = unit(0.75, "in"), pad_y = unit(0.5, "in"),
        style = north_arrow_fancy_orienteering) +
    coord_sf(xlim = c(5, 13), ylim = c(57, 60))+
     guides(color = guide_legend(override.aes = list(size = 3,name = "Station Type" ) ) )

p + 
  scale_shape_discrete("Station Type") +
  scale_color_discrete("Station Type")



```


### Draw map, using geom_text_repel  
geom_text_repel() needs to have x and y in the data set as 'explicit' variables on the 'native' scale.  
So we must first transform the data, then add coordinates as variables. 
```{r}
# Transform data set to the native scale, here: UTM
sf_stations_utm <- st_transform(sf_stations, "+proj=utm +zone=33")

# Function for extracting coordinates from one map feature   
get_coor <- function(i, sf){
  p <- as.numeric(sf$geometry[[i]])
  tibble(x = p[1], y = p[2])
}
# test
# get_coor(1, sf_stations)

# Extract all coordinates and add to the data set
coor <- 1:nrow(sf_stations) %>% purrr::map_df(~get_coor(., sf_stations_utm))
sf_stations_utm$x <- coor$x
sf_stations_utm$y <- coor$y

ggplot(nc_norway) + 
  geom_sf() + 
  geom_sf(data = nc_rivers[sel,], color = "blue") + 
  geom_sf(data = sf_stations, aes(color = Station_type), show.legend = "point") + 
  scale_color_brewer("Station type", palette = "Set1") +
  geom_text_repel(data = sf_stations_utm, aes(x = x, y = y, label = Name)) +
  theme_bw() +
  coord_sf(ylim = c(6.45, 6.7)*1E6, xlim = c(0.05, 0.3)*1E6) +
  theme(axis.title = element_blank())

```
